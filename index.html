<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Bandsintown</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <link rel="stylesheet/less" type="text/css" href="less/styles.less" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.7.2/less.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js" type="text/javascript"></script>
    <script>
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    //localhost:3000/?artist=:url_escaped_artist_name
    //add this to the bandsintown api request in the GET path
    var urlArtist = getUrlParameter('artist');
    // console.log(urlArtist);

    // console.log(it.slice(1))

    var artistName = encodeURIComponent(urlArtist.slice(1));
    // console.log(artistName);

    var auth = "?app_id=bit_challenge";
    var requestURL = "https://rest.bandsintown.com/artists/" + artistName;
    var request = new XMLHttpRequest();
    request.open('GET', requestURL + auth);
    request.responseType = "json";
    request.send();

    request.onload = function() {
        var artistData = request.response;
        var responseArtistName = artistData.name;
        var artistThumbUrl = artistData.thumb_url;
        document.getElementById("artistN").innerHTML = responseArtistName;
        document.getElementById("thumbImage").src = artistThumbUrl;
    };

    var secondRequest = new XMLHttpRequest();
    secondRequest.open('GET', requestURL + "/events" + auth);
    secondRequest.responseType = "json";
    secondRequest.send();

    secondRequest.onload = function() {
        var artistEvents = secondRequest.response;
        // artistEvents = [];
        if (artistEvents.length >= 1) {
            for (var i = 0; i < artistEvents.length; i++) {
                //grab the table
                var table = document.getElementById("table");
                table.className = "table";
                //create a new row
                var row = document.createElement("div");
                row.className = "row";
                table.appendChild(row);

                //get datetime, create a span, add it to the row
                var dateAndTime = artistEvents[i].datetime;
                console.log(moment(dateAndTime).format("MMM D"));
                var monthDate = moment(dateAndTime).format("MMM D");
                var newMonthDateNode = document.createElement("span");
                newMonthDateNode.className = "monthDate";
                newMonthDateNode.textContent = monthDate;
                row.appendChild(newMonthDateNode);

                //PRINT VENUE NAME
                var venueName = artistEvents[i].venue.name;
                var newVenueName = document.createElement("span");
                newVenueName.className = "venueName";
                newVenueName.textContent = venueName;
                row.appendChild(newVenueName);
                console.log(venueName);

                //PRINT CITY, STATE or CITY, REGION
                var venueLocation;
                if (artistEvents[i].venue.country === "United States") {
                    venueLocation = venue.city + ", " + venue.region;
                } else {
                    venueLocation = artistEvents[i].venue.city + ", " + artistEvents[i].venue.country;
                    console.log(venueLocation);
                }
                var newVenueLocation = document.createElement("span");
                newVenueLocation.className = "venueLocation";
                newVenueLocation.textContent = venueLocation;
                row.appendChild(newVenueLocation);

                //DISPLAY TICKETS BUTTON THAT LINKS TO URL
                var newTicketButton;
                if (artistEvents[i].offers.length >= 1) {
                    var newButton = document.createElement("a");
                    newButton.textContent = "Tickets";
                    newButton.setAttribute('href', artistEvents[i].offers[0].url);
                    console.log(artistEvents[i].offers[0].url);
                    newTicketButton = document.createElement("span");
                    newTicketButton.className = "ticketsButton";
                    newTicketButton.appendChild(newButton);
                } else {
                    newTicketButton = document.createElement("span");
                    newTicketButton.className = "ticketsButton";
                    newTicketButton.textContent = "";
                }

                row.appendChild(newTicketButton);
            }
        } else {
            var tableElem = document.getElementById("table");
            tableElem.textContent = "No upcoming events.";
            tableElem.className = "noUpcomingEvents";
        }
    };
    </script>
</head>

<body>
    <div id="container">
        <div id="top">
            <div id="leftImage">
                <img id="thumbImage">
            </div>
            <div id="textRightOfImage">
                <strong id="artistN"></strong>
                <p id="upcomingEvents">Upcoming Events</p>
            </div>
        </div>
        <div id="table">
            <!-- create a div with 4 spans in it -->
        </div>
    </div>
</body>

</html>